import{_ as s,c as n,o as a,a as l}from"./app.d474d6c4.js";const C=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[{"level":2,"title":"commitLayoutEffects","slug":"commitlayouteffects","link":"#commitlayouteffects","children":[{"level":3,"title":"\u7C7B\u7EC4\u4EF6","slug":"\u7C7B\u7EC4\u4EF6","link":"#\u7C7B\u7EC4\u4EF6","children":[]},{"level":3,"title":"\u51FD\u6570\u7EC4\u4EF6","slug":"\u51FD\u6570\u7EC4\u4EF6","link":"#\u51FD\u6570\u7EC4\u4EF6","children":[]}]},{"level":2,"title":"\u6267\u884C\u5B8C commitLayoutEffects","slug":"\u6267\u884C\u5B8C-commitlayouteffects","link":"#\u6267\u884C\u5B8C-commitlayouteffects","children":[{"level":3,"title":"flushPassiveEffects","slug":"flushpassiveeffects","link":"#flushpassiveeffects","children":[]}]},{"level":2,"title":"\u6CE8\u610F\u70B9","slug":"\u6CE8\u610F\u70B9","link":"#\u6CE8\u610F\u70B9","children":[]}],"relativePath":"React/03-commit/3.4.layout\u9636\u6BB5.md"}'),p={name:"React/03-commit/3.4.layout\u9636\u6BB5.md"},o=l(`<p>\u8BE5\u9636\u6BB5\u4EE3\u7801\u5728 <code>mutation</code> \u5B8C\u6210\uFF08DOM \u4FEE\u6539\u5B8C\u6210\uFF09\u4E4B\u540E\u6267\u884C</p><blockquote><p>\u6CE8\u610F\uFF1A\u7531\u4E8E JS \u7684\u540C\u6B65\u6267\u884C\u963B\u585E\u4E86\u4E3B\u7EBF\u7A0B\uFF0C\u6240\u4EE5\u6B64\u65F6 JS \u5DF2\u7ECF\u53EF\u4EE5\u83B7\u53D6\u5230\u65B0\u7684<code>DOM</code>\uFF0C\u4F46\u662F\u6D4F\u89C8\u5668\u5BF9\u65B0\u7684<code>DOM</code>\u5E76\u6CA1\u6709\u5B8C\u6210\u6E32\u67D3\u3002</p></blockquote><blockquote><p>\u8BE5\u9636\u6BB5\u89E6\u53D1\u7684\u751F\u547D\u5468\u671F\u94A9\u5B50\u548C<code>hook</code>\u53EF\u4EE5\u76F4\u63A5\u8BBF\u95EE\u5230\u5DF2\u7ECF\u6539\u53D8\u540E\u7684<code>DOM</code>\uFF0C\u5373\u8BE5\u9636\u6BB5\u662F\u53EF\u4EE5\u53C2\u4E0E<code>DOM layout</code>\u7684\u9636\u6BB5\u3002</p></blockquote><h2 id="commitlayouteffects" tabindex="-1">commitLayoutEffects <a class="header-anchor" href="#commitlayouteffects" aria-hidden="true">#</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// ReactFiberWorkLoop.js</span></span>
<span class="line"><span style="color:#676E95;">// commitRootImpl \u51FD\u6570\u5185\u8C03\u7528</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitRootImpl</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u4E0A\u9762\u662Fmutation \u9636\u6BB5</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// ...\u540C\u6837\u662F\u901A\u8FC7\u904D\u5386 effectList</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u6B64\u65F6\u5DF2\u7ECF\u5B8C\u6210\u65B0 Fiber \u6811\u7684\u6E32\u67D3\uFF0C\u4FEE\u6539FiberRootNode \u7684 current \u6307\u9488\uFF0C\u6307\u5411\u65B0\u7684\u6811</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// layout \u9636\u6BB5 \u4F1A\u8C03\u7528 componentDidMount/ Update \u751F\u547D\u5468\u671F\uFF0C\u7528\u5230\u65B0\u7684 Fiber</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">do</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">commitLayoutEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lanes</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">	</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// commitLayoutEffects</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitLayoutEffects</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">lanes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">flags</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;">// \u8C03\u7528\u751F\u547D\u5468\u671F\u94A9\u5B50\u548Chook</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">Update</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Callback</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">alternate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">commitLayoutEffectOnFiber</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">committedLanes</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	    </span><span style="color:#676E95;">// \u8D4B\u503C ref</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Ref</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		    </span><span style="color:#82AAFF;">commitAttachRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nextEffect</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="\u7C7B\u7EC4\u4EF6" tabindex="-1">\u7C7B\u7EC4\u4EF6 <a class="header-anchor" href="#\u7C7B\u7EC4\u4EF6" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// ReactFiberCommitWork.js</span></span>
<span class="line"><span style="color:#676E95;">// \u5F15\u5165\u522B\u540D commitLayoutEffectOnFiber</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitLifeCycles</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#A6ACCD;">finishedRoot</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">current</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">committedLanes</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;">// \u6839\u636E Fiber\u7684 tag \u6267\u884C</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ClassComponent</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// \u7C7B\u7EC4\u4EF6</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">stateNode</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Update</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;">// \u89E6\u53D1 \u751F\u547D\u5468\u671F\u94A9\u5B50</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">current</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">					</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">componentDidMount</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">					</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">componentDidUpdate</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">						</span><span style="color:#A6ACCD;">prevProps</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						</span><span style="color:#A6ACCD;">prevState</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">						</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__reactInternalSnapshotBeforeUpdate</span></span>
<span class="line"><span style="color:#F07178;">					)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;">// setState \u7684 \u7B2C\u4E8C\u4E2A\u53C2\u6570\uFF08\u56DE\u8C03\u51FD\u6570\u5728\u6B64\u6267\u884C)</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#82AAFF;">commitUpdateQueue</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="\u51FD\u6570\u7EC4\u4EF6" tabindex="-1">\u51FD\u6570\u7EC4\u4EF6 <a class="header-anchor" href="#\u51FD\u6570\u7EC4\u4EF6" aria-hidden="true">#</a></h3><blockquote><p>\u8C03\u7528<code>useLayoutEffect hook</code>\u7684<code>\u56DE\u8C03\u51FD\u6570</code>\uFF0C\u8C03\u5EA6<code>useEffect</code>\u7684<code>\u9500\u6BC1</code>\u4E0E<code>\u56DE\u8C03</code>\u51FD\u6570</p></blockquote><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitLifeCycles</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">switch</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;">// \u51FD\u6570\u7EC4\u4EF6\u76F8\u5173</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">case</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">FunctionComponent</span><span style="color:#89DDFF;">:{</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// useLayoutHook \u56DE\u8C03</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">commitHookEffectListMount</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">HookLayout</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HookHasEffect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// useEffect \u56DE\u8C03\u7684\u8C03\u5EA6</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">schedulePassiveEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="commithookeffectlistmount" tabindex="-1">commitHookEffectListMount <a class="header-anchor" href="#commithookeffectlistmount" aria-hidden="true">#</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// ReactFiberCommitWork.js</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitHookEffectListMount</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tag</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// tag\uFF1A\u4F20\u5165\u7684HookLayout\uFF0C\u8868\u793A\u6267\u884C\u7684\u662F useLayoutHook</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// finishedWork\uFF1AApp Fiber\u8282\u70B9</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">do</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">create</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">create</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">destroy</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">create</span><span style="color:#F07178;">() </span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;">// layoutEffect \u8FD4\u56DE\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u4F5C\u4E3Adestroy</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;">// destroy \u5728 mutation \u9636\u6BB5\u5148\u8C03\u7528\uFF0C\u7136\u540E\u5728 layout \u9636\u6BB5\u8C03\u7528 create</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;">// destroy \u548C create \u90FD\u662F\u540C\u6B65\u8C03\u7528</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="schedulepassiveeffects" tabindex="-1">schedulePassiveEffects <a class="header-anchor" href="#schedulepassiveeffects" aria-hidden="true">#</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">schedulePassiveEffects</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">any</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">updateQueue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastEffect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">do</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tag</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">	        (</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HookPassive</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoHookEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">	        (</span><span style="color:#A6ACCD;">tag</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">HookHasEffect</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NoHookEffect</span></span>
<span class="line"><span style="color:#F07178;">	      ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		      </span><span style="color:#676E95;">// \u63A8\u8FDB\u8C03\u5EA6\u961F\u5217\u4E2D</span></span>
<span class="line"><span style="color:#F07178;">	        </span><span style="color:#82AAFF;">enqueuePendingPassiveHookEffectUnmount</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	        </span><span style="color:#82AAFF;">enqueuePendingPassiveHookEffectMount</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">finishedWork</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	      </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">next</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">firstEffect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">enqueuePendingPassiveHookEffectUnmount</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fiber</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">pendingPassiveHookEffectsUnmount</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fiber</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// rootDoesHavePassiveEffects \u7528\u4E8E\u6807\u8BB0\u672C\u6B21\u66F4\u65B0\u4E2D\u5B58\u5728useEffect \u56DE\u8C03</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">rootDoesHavePassiveEffects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">rootDoesHavePassiveEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">scheduleCallback</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">NormalSchedulerPriority</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// \u8C03\u5EA6\u56DE\u8C03\u51FD\u6570</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;">// \u5185\u90E8\u4E3B\u8981\u662F\u904D\u5386 \u4E4B\u524D\u7684 effect \u9500\u6BC1\uFF08destroy\uFF09\u548C \u65B0\u7684 create \u56DE\u8C03</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">flushPassiveEffects</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h2 id="\u6267\u884C\u5B8C-commitlayouteffects" tabindex="-1">\u6267\u884C\u5B8C commitLayoutEffects <a class="header-anchor" href="#\u6267\u884C\u5B8C-commitlayouteffects" aria-hidden="true">#</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">commitRootImpl</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">//...commitLayoutEffects(root, lanes);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">nextEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u81F3\u6B64 commit \u4E09\u4E2A\u5B50\u9636\u6BB5\u5B8C\u6210</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u4E0A\u9762\u63A8\u5165\u8C03\u5EA6\u961F\u5217\u8FC7\u7A0B\u4E2D\u8D4B\u503C\u4E3A true</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">rootDoesHavePassiveEffects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">rootDoesHavePassiveEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">rootWithPendingPassiveEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="flushpassiveeffects" tabindex="-1">flushPassiveEffects <a class="header-anchor" href="#flushpassiveeffects" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// \u5185\u90E8\u8C03\u7528</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">flushPassiveEffectsImpl</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u8BE5\u51FD\u6570\u6267\u884C\u4E86 useEffect \u7684 destroy \u56DE\u8C03 \u548C \u672C\u6B21\u66F4\u65B0\u7684 create \u56DE\u8C03</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u4E0A\u9762\u8D4B\u503C\u4E86\u4E3A root</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">rootWithPendingPassiveEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">unmountEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pendingPassiveHookEffectsUnmount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u904D\u5386\u6267\u884C unmountEffects \u4E2D\u7684 destroy</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">mountEffects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">pendingPassiveHookEffectsMount</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;">// \u904D\u5386\u6267\u884C create</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="\u6CE8\u610F\u70B9" tabindex="-1">\u6CE8\u610F\u70B9 <a class="header-anchor" href="#\u6CE8\u610F\u70B9" aria-hidden="true">#</a></h2><p><code>useLayoutEffect</code> \u662F <strong>\u5728commit\u9636\u6BB5\u4E2D\u540C\u6B65\u6267\u884C</strong> \u7684\uFF0C\u5982\u679C\u5728\u5176 create \u56DE\u8C03\u4E2D\u4EA7\u751F\u65B0\u7684 setState \uFF0C\u7531\u4E8E\u540C\u6B65\u6267\u884C\uFF08\u7B2C\u4E00\u6B21 <code>setState</code>\uFF0C\u56DE\u8C03\uFF0C\u56DE\u8C03\u4E2D\u518D\u6B21 <code>setState</code>\uFF0C\u4F1A\u518D\u6B21\u6267\u884C <code>useLayout</code> \u56DE\u8C03\uFF09\u4E0D\u4F1A\u5728\u5C4F\u5E55\u4E0A\u663E\u793A <code>\u4E2D\u95F4\u503C</code></p><p><code>useEffect</code> \u662F <strong>commit \u9636\u6BB5\u4E4B\u540E\u5F02\u6B65\u6267\u884C</strong>\uFF0C\u662F<code>\u53EF\u80FD\u4F1A\u663E\u793A</code></p>`,21),e=[o];function t(c,r,F,y,D,i){return a(),n("div",null,e)}const f=s(p,[["render",t]]);export{C as __pageData,f as default};
